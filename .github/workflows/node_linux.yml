name: Node on Linux
on:
  workflow_run:
    workflows: [Prepare Binary]
    branches: ["**"]  
    types:
      - completed  
jobs:
  node_linux:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    strategy:
      matrix:
        include:
          - job: record_latest_replay_build
            record_src: latest
            replay_src: build
          - job: record_build_replay_latest
            record_src: build
            replay_src: latest
          - job: record_build_replay_build
            record_src: build
            replay_src: build
    name: ${{ matrix.job }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - id: record
      uses: ./.github/actions/download-binary
      with:
        src: ${{ matrix.record_src }}

    - id: replay
      uses: ./.github/actions/download-binary
      with:
        src: ${{ matrix.replay_src }}

    - name: Build Keploy binary
      run: |
        go build -race -tags=viper_bind_struct -o keployv2

    - name: Checkout samples-typescript repository
      uses: actions/checkout@v4
      with:
        repository: keploy/samples-typescript
        path: samples-typescript

    - name: Run the express-mongoose app
      env:
        RECORD_BIN: ${{ steps.record.outputs.path }}
        REPLAY_BIN: ${{ steps.replay.outputs.path }}
    run: |
        cd samples-typescript/express-mongoose
        source ./../../.github/workflows/test_workflow_scripts/node-linux.sh